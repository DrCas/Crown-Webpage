{% extends "base.html" %}
{% block content %}

<div class="page">
  <div class="container">

    <div class="card job-card">
      <div class="cardtop">
        <div>
          <div class="title">{{ job_display_name(job) }}</div>
          <div class="meta">
            Customer: {{ job.customer_name }}
            {% if job.business_name %} • Business: {{ job.business_name }}{% endif %}
            • Received: {{ job.received_date|mmddyyyy_date }}
            • Created: {{ job.created_at|mmddyyyy_dt }}
          </div>
        </div>

        <div class="btnrow" style="margin-top:0;">
          <a href="{{ url_for('job_edit', job_id=job.id) }}" class="btn btn-primary">Edit Job</a>
          <form method="POST" action="{{ url_for('job_view', job_id=job.id) }}" style="display:inline;">
            <input type="hidden" name="action" value="update_stage">
            <button class="btn btn-primary" type="submit">Update Progress</button>
          </form>

          {% if current_user.is_admin() %}
          <form method="POST" action="{{ url_for('job_delete', job_id=job.id) }}" style="display:inline;" onsubmit="return confirm('Delete this job? This cannot be undone.');">
            <button class="btn btn-danger" type="submit">Delete Job (Admin)</button>
          </form>
          {% endif %}
        </div>
      </div>

      <div class="progress-wrap">
        <div class="progress-bar">
          {% set idx = stage_index(job) %}
          {% for s in STAGES %}
            {% set i = loop.index0 %}
            <div class="seg {% if i < idx %}done{% elif i == idx %}current{% else %}pending{% endif %}"></div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="job-two-col">

      <!-- LEFT: Job details + edit -->
      <div class="panel">

        <div class="section-label">Job Details</div>
        <section class="card job-card">
          <div class="info-grid">

            <div class="info-row"><div class="label">Phone</div><div class="value">{{ job.phone_number or "—" }}</div></div>
            <div class="info-row"><div class="label">Email</div><div class="value">{{ job.email_address or "—" }}</div></div>
            <div class="info-row"><div class="label">PO</div><div class="value">{{ job.po_date_key }}-{{ "%02d"|format(job.po_seq) }}</div></div>
            <div class="info-row"><div class="label">Current Stage</div><div class="value">{{ job.stage }}</div></div>
            <div class="info-row"><div class="label">Quote</div><div class="value">{% if job.quote_amount is not none %}${{ "%.2f"|format(job.quote_amount) }}{% else %}—{% endif %}</div></div>
            <div class="info-row"><div class="label">Date Received</div><div class="value">{{ job.received_date|mmddyyyy_date }}</div></div>

            <div class="info-row">
              <div class="label">Details / Notes</div>
              <div class="value prewrap">{{ job.job_details or "—" }}</div>
            </div>

            {% if job.uploaded_files_json %}
              {% set files = job.uploaded_files_json | fromjson %}
              {% if files %}
                <div class="info-row">
                  <div class="label">Attachments</div>
                  <div class="value">
                    <ul class="attachments-list">
                      {% for p in files %}
                        {% if p is mapping %}
                          {% set label = p.get('filename') or p.get('saved_as') %}
                          {% set fname = p.get('saved_as') or p.get('filename') %}
                        {% else %}
                          {% set label = p.split('/')[-1] %}
                          {% set fname = p.split('/')[-1] %}
                        {% endif %}
                        <li>
                          <a class="attachment-link" href="/uploads/orders/{{ fname }}" target="_blank" rel="noopener">
                            {{ label }}
                          </a>
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              {% endif %}
            {% endif %}

          </div>
        </section>



      </div>

      <!-- RIGHT: Order intake / Raw JSON -->
      <div class="panel">


        <div class="section-label">Order Intake</div>
        <section class="card job-card">
          {% if job.submission_json %}
            <div class="kvrows">
              <div class="row"><div class="k">Name</div><div class="v">{{ job.customer_name }}</div></div>
              <div class="row"><div class="k">Email</div><div class="v">{{ job.email_address or "—" }}</div></div>
              <div class="row"><div class="k">Phone</div><div class="v">{{ job.phone_number or "—" }}</div></div>
              <div class="row"><div class="k">Source</div><div class="v">{{ job.source or "—" }}</div></div>
            </div>

            <div class="section-label" style="margin-top:14px;">Summary</div>
            <div class="textblock">{{ job.job_summary or "—" }}</div>

            <div class="small" style="margin-top:10px;">Order ID: {{ job.intake_order_id or "—" }}</div>
          {% else %}
            <div class="sub">No customer intake data is attached to this job yet.</div>
            <div class="small" style="margin-top:8px;">(This usually means it was created manually in the admin portal.)</div>
          {% endif %}
        </section>

      </div>

    </div>

    {% if current_user.is_admin() %}
      <div class="section-label">Audit Log (Admin Only)</div>
      <section class="card job-card">
        <div class="sub" style="margin-bottom:10px;">Tracks who changed progress/fields and when.</div>

        {% if not logs %}
          <div class="small">No log entries yet.</div>
        {% else %}
          <div class="table-wrap">
            <table class="items-table">
              <thead>
                <tr>
                  <th style="width: 170px;">Time</th>
                  <th style="width: 160px;">User</th>
                  <th style="width: 160px;">Action</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody>
                {% for entry in logs %}
                  <tr>
                    <td>{{ entry.timestamp|mmddyyyy_dt }}</td>
                    <td>{{ entry.actor_username or "—" }}</td>
                    <td>{{ entry.action }}</td>
                    <td class="prewrap">{{ entry.details or "—" }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      </section>
    {% endif %}

  </div>
</div>

<style>
  .job-view-page { max-width: 1200px; margin: 0 auto; padding: 18px 14px; }
  .page-header { display:flex; align-items:flex-start; justify-content:space-between; gap: 12px; margin-bottom: 14px; flex-wrap:wrap; }
  .page-title h1 { margin: 0; font-size: 1.45rem; letter-spacing: .2px; }
  .subtle { opacity: .8; margin-top: 4px; }
  .muted { opacity: .75; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

  .two-col { display:grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-top: 14px; }
  @media (max-width: 900px) { .two-col { grid-template-columns: 1fr; } }

  .card.box { border-radius: 14px; padding: 14px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); backdrop-filter: blur(10px); }
  .card-title { font-weight: 800; margin-bottom: 10px; letter-spacing: .2px; }

  .overview-grid { display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 12px; }
  @media (max-width: 900px) { .overview-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
  .overview-item { padding: 10px; border-radius: 12px; background: rgba(0,0,0,.14); border: 1px solid rgba(255,255,255,.08); }
  .overview-item .label { font-size: .78rem; opacity: .78; margin-bottom: 4px; }
  .overview-item .value { font-size: 1rem; font-weight: 800; }
  .pill { display:inline-flex; align-items:center; padding: 3px 10px; border-radius: 999px; background: rgba(255,255,255,.10); border: 1px solid rgba(255,255,255,.10); font-weight: 800; font-size: .85rem; }

  .stage-form { margin-top: 12px; }
  .stage-row { display:flex; justify-content:space-between; gap: 12px; align-items:end; flex-wrap:wrap; }
  .stage-left { min-width: 260px; }
  .small-label { display:block; font-size:.82rem; opacity:.85; margin-bottom: 6px; }
  select { width:100%; padding: 10px 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.18); color: inherit; }

  .progress-wrap { margin-top: 12px; }
  .progress-bar { height: 10px; width: 100%; border-radius: 999px; background: rgba(255,255,255,.10); border: 1px solid rgba(255,255,255,.10); overflow:hidden; }
  .progress-fill { height: 100%; border-radius: 999px; background: rgba(255,255,255,.65); }
  .progress-meta { display:flex; justify-content:flex-end; margin-top: 6px; font-size: .85rem; }

  .info-grid { display:flex; flex-direction:column; gap: 10px; }
  .info-row { display:grid; grid-template-columns: 160px 1fr; gap: 10px; align-items:start; }
  @media (max-width: 500px) { .info-row { grid-template-columns: 1fr; } }
  .info-row .label { font-size: .82rem; opacity: .78; }
  .info-row .value { font-weight: 650; }
  .prewrap { white-space: pre-wrap; line-height: 1.35; }

  .table-wrap { overflow:auto; }
  .items-table { width:100%; border-collapse: collapse; }
  .items-table th, .items-table td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,.10); vertical-align: top; text-align: left; }
</style>

{% endblock %}